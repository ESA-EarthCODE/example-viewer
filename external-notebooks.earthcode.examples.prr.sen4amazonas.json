{"version":2,"kind":"Notebook","sha256":"a9be5e99836de376920435f49bb1d8382ed5f516bd607212f84f9342a0f485f3","slug":"external-notebooks.earthcode.examples.prr.sen4amazonas","location":"/external_notebooks/earthcode/examples/PRR/sen4amazonas.ipynb","dependencies":[],"frontmatter":{"title":"Sen4Amazonas: Time-Series Forest Loss Zarr Cube","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"pangeo","language":"python"},"github":"https://github.com/esa-earthcode/example-viewer/","subject":"EarthCODE Examples","numbering":{"title":{"offset":4}},"source_url":"https://github.com/esa-earthcode/example-viewer//blob/main/external_notebooks/earthcode/examples/PRR/sen4amazonas.ipynb","edit_url":"https://github.com/esa-earthcode/example-viewer//edit/main/external_notebooks/earthcode/examples/PRR/sen4amazonas.ipynb","exports":[{"format":"ipynb","filename":"sen4amazonas.ipynb","url":"/example-viewer/build/sen4amazonas-431eb0b225392322578f7c9f5f35a8a5.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Goal","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Lr4QEHhjpC"}],"key":"dEhWsy7aod"},{"type":"text","value":": Produce a time-indexed Zarr data cube of forest-loss masks for the Amazonas region to enable scalable analysis and visualization. This example is based on the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Vb0BpDFSlc"},{"type":"link","url":"https://sen4ama.gisat.cz/","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Sentinel for amazonas project","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"LuJZN89GQ5"}],"urlSource":"https://sen4ama.gisat.cz/","key":"lQIWJnGqBX"},{"type":"text","value":" project.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"pPzPznM3IR"}],"key":"J6mthlsM2X"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Classes","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"j2b0zm5I0u"}],"key":"PmGEx2srAR"},{"type":"text","value":":","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"z9Xgi6SnUA"}],"key":"o09TgBHckn"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":6,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"1","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"IRIhllE3yT"},{"type":"text","value":" — forest loss","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"NzqfYzV2iM"}],"key":"ybUEq2iRzc"}],"key":"rOs8yZcqMD"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"inlineCode","value":"0","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"a5ZGMw8EOb"},{"type":"text","value":" — no data / background (treated as missing)","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"F594twFjtL"}],"key":"AWebwYNFzD"}],"key":"hsZSEUtgCt"}],"key":"cISClaUHum"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"strong","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Study area and grid","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"cxgYD3xGHD"}],"key":"XslyYFg1Au"},{"type":"text","value":":","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"UJmDec9MHI"}],"key":"xLtu6ataX9"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":10,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"CRS: ","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"OPJOPxGIb7"},{"type":"inlineCode","value":"EPSG:4326","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"IdJAYl08pq"}],"key":"Tew6NzzgQ1"}],"key":"p19jSw8nu6"},{"type":"listItem","spread":true,"position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Bounds: ","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"GJv3f0N8Ys"},{"type":"inlineCode","value":"-79.1997438, -17.27354892, -44.91217178, 9.0467434","position":{"start":{"line":11,"column":1},"end":{"line":11,"column":1}},"key":"DephwO21HC"}],"key":"aUq0sB70q7"}],"key":"EVqD98SfLB"},{"type":"listItem","spread":true,"position":{"start":{"line":12,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Resolution: ","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"tYD3U6kNta"},{"type":"inlineCode","value":"0.00017966","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"Bkhj7L4PhT"},{"type":"text","value":" degrees (see ","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"QwTLVvGglF"},{"type":"inlineCode","value":"gdalwarp","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"xCmMO8JZIx"},{"type":"text","value":" step)","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"ppFyxRXpxk"}],"key":"WXrYpGIKb6"}],"key":"YCx2swoNGo"}],"key":"cKAIEOAUyT"},{"type":"paragraph","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"strong","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"Workflow overview","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"BN7E5NTvKT"}],"key":"GpySA6SVOe"},{"type":"text","value":":","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"hYalgdncbi"}],"key":"bBcs8GgPz6"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":15,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Convert each GeoTIFF mosaic to per-date Zarr with ","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"DLwliffqNq"},{"type":"inlineCode","value":"gdalwarp","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"YBUtCx94RA"},{"type":"text","value":".","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"br6hpT42Kn"}],"key":"JI4A3qLPnF"}],"key":"Lw7BNFwnlv"},{"type":"listItem","spread":true,"position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Build a sorted list of Zarr stores and timestamps.","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"CEcv3ELgHR"}],"key":"DNStIfeqdq"}],"key":"fTX9giJhEG"},{"type":"listItem","spread":true,"position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Initialize an empty target cube (","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"ePU1EFIWX1"},{"type":"inlineCode","value":"cube.zarr","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"DO7JKzHAlb"},{"type":"text","value":") with the full time axis.","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"OV4bG6Fgni"}],"key":"UVsEQCPoFo"}],"key":"WS3UFtoXZ9"},{"type":"listItem","spread":true,"position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Append each slice into the cube using ","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"aqeSEedMKM"},{"type":"inlineCode","value":"region","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"SgIT6YeaaJ"},{"type":"text","value":" writes.","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"gG5vjUMki5"}],"key":"qpNXCvxElz"}],"key":"IM6op4bkGr"},{"type":"listItem","spread":true,"position":{"start":{"line":19,"column":1},"end":{"line":20,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Tune chunking for performance and memory.","position":{"start":{"line":19,"column":1},"end":{"line":19,"column":1}},"key":"tstnW2xbui"}],"key":"uuB6QnYAmt"}],"key":"Nq97MGUQlP"}],"key":"FUtqnbqBpm"},{"type":"paragraph","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"strong","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"text","value":"Requirements","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"ENZ19dsgny"}],"key":"YJ8B1PRODX"},{"type":"text","value":":","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"MzLGORN1Jl"}],"key":"tbejS4ycRK"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":22,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"GDAL built with Zarr driver (","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"zaOTSDolk1"},{"type":"inlineCode","value":"gdalwarp -of Zarr","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"J1v1p9pOFp"},{"type":"text","value":")","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"adRzYZ7jo1"}],"key":"B5LtEV0RRO"}],"key":"RwHjvOEpK5"},{"type":"listItem","spread":true,"position":{"start":{"line":23,"column":1},"end":{"line":24,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Python: ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"YBw6wesYNc"},{"type":"inlineCode","value":"xarray","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"qtyD2vHQF5"},{"type":"text","value":", ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"xLhWweibJ7"},{"type":"inlineCode","value":"rioxarray","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"yKesWCaK4L"},{"type":"text","value":", ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"eLdqpa5EtH"},{"type":"inlineCode","value":"zarr","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"cDoPkfmiie"},{"type":"text","value":", ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"oZDQIuw4pm"},{"type":"inlineCode","value":"dask[distributed]","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"scUjawZH2I"},{"type":"text","value":", ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"RdvkiSDRlD"},{"type":"inlineCode","value":"numpy","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"ShSYE5BuzJ"},{"type":"text","value":", ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"SokDMdPFrY"},{"type":"inlineCode","value":"pandas","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"lGm2FcAgLb"},{"type":"text","value":", optionally ","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"CGizWASxLT"},{"type":"inlineCode","value":"hvplot.xarray","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"AT3pASuhXU"},{"type":"text","value":" for quick QA","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"LvwGwEIInU"}],"key":"icnZbD00VM"}],"key":"bkPPZJcode"}],"key":"EzanPGsbXL"},{"type":"paragraph","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"strong","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"text","value":"Data layout","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"f07g7JuxaX"}],"key":"MhTnj5rrZn"},{"type":"text","value":":","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"U4FrFTuVxN"}],"key":"m1DGAX1nBa"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":26,"column":1},"end":{"line":28,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Input: ","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"VGhc7YYdP1"},{"type":"inlineCode","value":"mosaics/*.tif","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"zY5vTIsaLG"},{"type":"text","value":" (per-date masks)","position":{"start":{"line":26,"column":1},"end":{"line":26,"column":1}},"key":"uPzpVDvamk"}],"key":"MHpqGZeZYx"}],"key":"VDnd2Jy4eW"},{"type":"listItem","spread":true,"position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Intermediate: ","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"z3qLzBHa84"},{"type":"inlineCode","value":"mosaics/*.zarr","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"H3V38rsaro"},{"type":"text","value":" (per-date stores)","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"S65CZP0Ug0"}],"key":"aDLo3Ga0BE"}],"key":"d3ljVd6to1"},{"type":"listItem","spread":true,"position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Output: ","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"UV2eJqtwp4"},{"type":"inlineCode","value":"cube.zarr","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"TSof2AGnM3"},{"type":"text","value":" (time-series cube)","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"fRzxOptEt9"}],"key":"j2hk1qOArK"}],"key":"cVxtK5UiII"}],"key":"km0SMv6A6a"}],"key":"U3MvEPmTkE"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Discussion","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Al0LmsOtsz"}],"identifier":"discussion","label":"Discussion","html_id":"discussion","implicit":true,"key":"Rqu7z4FcsB"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"When handling many temporal slices in Earth Observation, storing them as a single Zarr data cube is far superior to managing hundreds of COGs linked via a STAC collection because Zarr treats time as a first-class dimension within a unified array structure rather than as disconnected files. This enables efficient temporal queries and parallel access using chunked, compressed blocks that map directly to analysis patterns like pixel-wise time series or rolling statistics, all without the per-file latency, catalog management, and HTTP overhead that cripple COG-based stacks at scale.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"djWnaNRCnv"}],"key":"JEWsHERPeb"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"To learn more read the ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"wTcrJzDLSF"},{"type":"link","url":"https://esa-earthcode.github.io/documentation/Community%20and%20Best%20Practices/Data%20and%20Workflow%20Best%20Practices/Data/","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"EarthCODE data best practices pages","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"N4V5nz550V"}],"urlSource":"https://esa-earthcode.github.io/documentation/Community%20and%20Best%20Practices/Data%20and%20Workflow%20Best%20Practices/Data/","key":"v42ZT8UQ4G"}],"key":"nnqgN6CA19"}],"key":"gHKzbBkApm"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"1) Convert GeoTIFFs to Zarr with GDAL","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OmIVIXh2UR"}],"identifier":"id-1-convert-geotiffs-to-zarr-with-gdal","label":"1) Convert GeoTIFFs to Zarr with GDAL","html_id":"id-1-convert-geotiffs-to-zarr-with-gdal","implicit":true,"key":"EN8HS6tlZu"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Use GDAL to warp each input GeoTIFF to ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"A3jCz0Wu1g"},{"type":"inlineCode","value":"EPSG:4326","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"tprHYRxB5B"},{"type":"text","value":", clip to the Amazonas extent, set the target resolution, and write per-date Zarr stores. Adjust ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ZE4cIoMq7z"},{"type":"inlineCode","value":"IN_DIR","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"UMZjKxJll1"},{"type":"text","value":", ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"E0TCynBCsp"},{"type":"inlineCode","value":"OUT_DIR","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"m1Ie1VQoT8"},{"type":"text","value":", bounds (","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"W2FHqbAGyl"},{"type":"inlineCode","value":"-te","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"dHO2iKk2U9"},{"type":"text","value":"), resolution (","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ZSxE5t77JE"},{"type":"inlineCode","value":"-tr","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"md62EbSvNp"},{"type":"text","value":"), and compression to match your data and hardware.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"R1n9hEPy2c"}],"key":"NthGsFrRxA"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Tip: Confirm Zarr support with ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"qCGt7fMl2D"},{"type":"inlineCode","value":"gdalinfo --formats | grep -i zarr","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"DnSAmrcBN5"},{"type":"text","value":".","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"juFkEaWqva"}],"key":"bHjLwyBZof"}],"key":"RVrk9WZIXq"},{"type":"block","kind":"notebook-content","children":[{"type":"code","lang":"bash","value":"%%bash\n#!/usr/bin/env bash\nset -euo pipefail\n\nIN_DIR=\"mosaics\"\nOUT_DIR=\"mosaics\"\n\nfor tif in \"${IN_DIR}\"/*.tif; do\n  base=\"$(basename \"${tif}\" .tif)\"\n  out=\"${OUT_DIR}/${base}.zarr\"\n\n  echo \"Warping ${tif} -> ${out}\"\n  gdalwarp -overwrite \\\n    -t_srs EPSG:4326 \\\n    -te -79.1997438 -17.27354892 -44.91217178 9.0467434 \\\n    -tr 0.00017966 0.00017966 \\\n    -r near \\\n    -dstnodata 0 \\\n    \"${tif}\" \\\n    \"${out}\" \\\n    -of Zarr \\\n    -multi -wo NUM_THREADS=ALL_CPUS \\\n    -co COMPRESS=ZSTD -co ZSTD_LEVEL=3 -co BLOCKSIZE=512,512\n\ndone","position":{"start":{"line":1,"column":1},"end":{"line":27,"column":1}},"key":"lOZQsqNa4j"}],"key":"GdSRKF8c1T"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"2) Python setup and file discovery","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cVj7LDJBiy"}],"identifier":"id-2-python-setup-and-file-discovery","label":"2) Python setup and file discovery","html_id":"id-2-python-setup-and-file-discovery","implicit":true,"key":"kWROTpJrcl"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Import libraries, set the input folder (","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"TXnrLFOslA"},{"type":"inlineCode","value":"mosaics/","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ORwF34ptCE"},{"type":"text","value":"), and collect per-date Zarr stores produced in step 1. Timestamps are parsed from filenames like ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"GqNkDq9fSQ"},{"type":"inlineCode","value":"prefix_YYYYMMDD.zarr","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"gq9UXLm1ld"},{"type":"text","value":". If your naming differs, adjust the parsing logic accordingly.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"M3U6HpN1IQ"}],"key":"HwJjMAUpBZ"}],"key":"NQIXKdZD0K"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import os\nimport rioxarray\nimport xarray as xr\nimport hvplot.xarray\nimport pandas as pd\nfrom pathlib import Path\n\nfolder = \"mosaics\"\nfiles = [os.path.join(folder, f) for f in os.listdir(folder) if f.endswith(\".zarr\")]\n# print(files)\n\ntimestamps = [\n    pd.to_datetime(os.path.splitext(Path(f).name)[0].split(\"_\")[1]) for f in files\n]\n# timestamps","key":"AUbyuJ6s7L"},{"type":"output","id":"kXboo2LUzPExsXIQmlKLk","data":[],"key":"lWcJdpkocq"}],"key":"A4wflGeTLm"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Sort files by timestamp","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Hi3E8eZlE1"}],"identifier":"sort-files-by-timestamp","label":"Sort files by timestamp","html_id":"sort-files-by-timestamp","implicit":true,"key":"IBd49r6Dug"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Ensure files and timestamps are aligned chronologically for consistent time indexing.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"FIlFApgWsU"}],"key":"tMhDxDMVsV"}],"key":"TKZk4zDTK2"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import numpy as np\nii = np.argsort(timestamps)\ntimestamps = np.array(timestamps)[ii]\nfiles = np.array(files)[ii]\n# files","key":"zkSbovYwlD"},{"type":"output","id":"hbFTUMYd3W82FbcGEB8_C","data":[],"key":"YezuQ6k5o5"}],"key":"L1t3HeXVKL"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Optional: Start a Dask client","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GHv728vfHQ"}],"identifier":"optional-start-a-dask-client","label":"Optional: Start a Dask client","html_id":"optional-start-a-dask-client","implicit":true,"key":"fEhAJpRTr8"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Spins up a local Dask scheduler/workers to parallelize IO and computation.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"pqKTKcxH6z"}],"key":"UbOlBXQLR7"}],"key":"xVA4lelj4C"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from distributed.client import Client\ncl = Client()\ncl","key":"OGfSUTBAoW"},{"type":"output","id":"dbxE21169MGwpf3bm_gTc","data":[],"key":"wsLkrxf5Rt"}],"key":"TRIT9qJAgm"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"3) Initialize target cube (template)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OkHJlh049D"}],"identifier":"id-3-initialize-target-cube-template","label":"3) Initialize target cube (template)","html_id":"id-3-initialize-target-cube-template","implicit":true,"key":"Ya4jMyAFv0"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Define chunk sizes and build a template dataset containing only the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FdWdL8SI3e"},{"type":"inlineCode","value":"time","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"UB44qWlQt0"},{"type":"text","value":" coordinate. This pre-allocates the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Xh9Y50c1ZV"},{"type":"inlineCode","value":"cube.zarr","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qHSugGfdSM"},{"type":"text","value":" store with the desired chunking.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"gTWMqKwKGw"}],"key":"xs7vfBee4c"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Note: Adjust chunk sizes (","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"aKfmDLSHT0"},{"type":"inlineCode","value":"x","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"EOMpt5jFuZ"},{"type":"text","value":", ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"sLakFwzh16"},{"type":"inlineCode","value":"y","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"KGHT7wG6wm"},{"type":"text","value":", ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"z22sf3ge9B"},{"type":"inlineCode","value":"time","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"PW6Wuq8AV9"},{"type":"text","value":") to balance memory, IO, and parallelism for your environment.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"btREnX8PXk"}],"key":"MMDpWoydsM"}],"key":"JFv55H3f5K"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\nchunk_size = {\"time\": 1,\"x\": 512*10, \"y\": 512*10}\ntemp_data = da.expand_dims({'time': timestamps.tolist()})\ntemp_das = xr.Dataset({'forest_loss': temp_data})\ntemp_das = temp_das.chunk(chunk_size)\ntemp_das","key":"llaZl7Iltx"},{"type":"output","id":"Euets4uwHgeNEdNcRGMlT","data":[],"key":"tjyFcFOy5s"}],"key":"ustl5gvVlW"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Write template to ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NttbZWHB49"},{"type":"inlineCode","value":"cube.zarr","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jmasRLpH5p"}],"identifier":"write-template-to-cube-zarr","label":"Write template to cube.zarr","html_id":"write-template-to-cube-zarr","implicit":true,"key":"Hxm1styr4C"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Create the target store with the full time axis and chosen chunks without writing data yet (","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"VA0I1p0lZT"},{"type":"inlineCode","value":"compute=False","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"xQuW9wx27B"},{"type":"text","value":").","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"SctkcjGywk"}],"key":"RQQGJUDQq0"}],"key":"EUmBSDWmKQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# write tempalte data that has al the timestamps\ntemp_das.forest_loss.attrs.pop(\"_FillValue\")\n\nenc = {\n    \"forest_loss\": {\n        \"_FillValue\": np.nan,\n        \"dtype\": np.float32,\n    }\n}\n\ntemp_das.to_zarr('cube.zarr', mode='w', compute=False, encoding=enc, write_empty_chunks=False, \n                 safe_chunks=True)","key":"kze6Dc9xn7"},{"type":"output","id":"Nq_cB1BWOEMrYt_yL1YGx","data":[],"key":"SM1IQjGTrZ"}],"key":"AlDIwxWxsr"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":4,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Chunking strategy","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dKzRTVXmZQ"}],"identifier":"chunking-strategy","label":"Chunking strategy","html_id":"chunking-strategy","implicit":true,"key":"jXTvyxLl7H"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Choose chunk sizes that fit in memory and align with access patterns (typical: larger ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"If8PCXfLEy"},{"type":"inlineCode","value":"x","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"LSp48NZLDf"},{"type":"text","value":"/","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"fIOb2WCoH1"},{"type":"inlineCode","value":"y","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Zvgp7sz6av"},{"type":"text","value":", small ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"BMNyQ0Kg8L"},{"type":"inlineCode","value":"time","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"LTrjzv4GNP"},{"type":"text","value":").","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"sRzucVIGic"}],"key":"l7A4qZofJL"}],"key":"z08Bqtff4A"},{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"You can override chunks when opening inputs, e.g.: ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"aC2iuqu9zB"},{"type":"inlineCode","value":"xr.open_dataset(f, engine=\"zarr\", chunks={\"X\": 512*10, \"Y\": 512*10})","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"V4rSjQ10mB"},{"type":"text","value":".","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"Go2u3p4hGa"}],"key":"CD2vO2gdgV"}],"key":"Kn7TCk4ICM"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Keep chunk shapes consistent across inputs and the target cube for best performance.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"PL9kEa59jR"}],"key":"q2yTiCHC4M"}],"key":"s0XspTQsll"}],"key":"fdam6UNtfP"}],"key":"YaZJHB6KuA"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"4) Append slices to the cube","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TvD2ddZKzx"}],"identifier":"id-4-append-slices-to-the-cube","label":"4) Append slices to the cube","html_id":"id-4-append-slices-to-the-cube","implicit":true,"key":"l5wzUQJAzD"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"For each per-date Zarr store:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"nb1qqLLgaI"}],"key":"LQx4CLOeDV"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Open with ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"crhb7l4Zv5"},{"type":"inlineCode","value":"xarray","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"bhlsN3xWiB"},{"type":"text","value":" and rename dims ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"WIGTWbqe13"},{"type":"inlineCode","value":"X/Y","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"l5E0iMwmHf"},{"type":"text","value":" to ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"KGFNF5Uct5"},{"type":"inlineCode","value":"x/y","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"qvfqvfyW92"},{"type":"text","value":".","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"Xs1ng6Vx7j"}],"key":"YMuDmWqRX4"}],"key":"XwVWMF6EMa"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Convert ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"s0KXHWpD8M"},{"type":"inlineCode","value":"0","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"QJjh48wnOd"},{"type":"text","value":" to missing (","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"zhdJeXZnVm"},{"type":"inlineCode","value":"NaN","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"rYqMKiLfFe"},{"type":"text","value":") so background doesn’t accumulate and skip writing empty chunks","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"yxxXx80D30"}],"key":"GGU6ZzzfT5"}],"key":"jqMKoYLdD8"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Attach CRS (","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"xLFUQq5XLP"},{"type":"inlineCode","value":"EPSG:4326","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"VuxpCoEzML"},{"type":"text","value":") and set spatial dims via ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"i5EqcVkUV5"},{"type":"inlineCode","value":"rioxarray","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"riFwSUH0SX"},{"type":"text","value":".","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"PEI2fSl2Bi"}],"key":"nyAKH96Tyn"}],"key":"gIWWZkV8Mk"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Expand with a singleton ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"n5zewRidqQ"},{"type":"inlineCode","value":"time","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"DmEbv38Z78"},{"type":"text","value":" coordinate and write into ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"lOTGCJ8Mq1"},{"type":"inlineCode","value":"cube.zarr","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"blIwgNG6ZZ"},{"type":"text","value":" at the matching ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"aCLIr4V3QN"},{"type":"inlineCode","value":"time","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"UIyrkDc7s8"},{"type":"text","value":" index using ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"KenLWCw3mM"},{"type":"inlineCode","value":"region","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"jbeiIqkbIW"},{"type":"text","value":".","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"CD4rgFQyuM"}],"key":"QRD3BWo0ao"}],"key":"d3kN3bwwXU"}],"key":"T14dR4eZgv"}],"key":"lslIqzaYjS"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"for i, (date, f) in enumerate(zip(timestamps, files)):\n    da = xr.open_dataset(f,\n             engine=\"zarr\", chunks={\"X\": 512*10, \"Y\": 512*10}) \n    da = da[next(iter(da.data_vars))]\n    da = da.rename({\"X\":\"x\", \"Y\":\"y\"})\n    da.name = \"forest_loss\"\n    da = da.where(da != 0)\n    da = da.rio.write_crs(\"EPSG:4326\")\n    da = da.rio.set_spatial_dims(x_dim=\"x\", y_dim=\"y\")   # <-- solves MissingSpatialDimensionError\n    da = da.expand_dims({'time': [date]})\n    da = da.chunk(chunk_size)\n    da.forest_loss.attrs.pop(\"_FillValue\")\n\n    enc = {\n        \"forest_loss\": {\n            \"_FillValue\": np.nan,\n            \"dtype\": np.float32,\n        }\n    }\n    da.drop_vars(['x', 'y', 'spatial_ref']).to_zarr('cube.zarr', encoding=enc, write_empty_chunks=False, safe_chunks=True, region={'time': slice(i, i+1)})\n    print(i)\n","key":"GqX0KdgVgt"},{"type":"output","id":"9buOA3BOe8QM_OK1m_dn_","data":[],"key":"Thfdb6Op3j"}],"key":"i7kKztjbXf"}],"key":"rERs2hByHp"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Generating STAC metadata for the YIPEEO project","url":"/external-notebooks/earthcode/examples/prr/prr-zarr","group":"PRR"},"next":{"title":"SmartCH4 project - δ13CH4 signatures","url":"/external-notebooks/earthcode/examples/prr/smartch4-signatures-modified","group":"PRR"}}},"domain":"http://localhost:3000"}